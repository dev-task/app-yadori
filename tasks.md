# 住まい口コミ SNS 開発タスク - モノレポ版

## 完了済みタスク

### REVIEW-1: 基本的なプロジェクト構造と Supabase 接続
- [x] Vite + React + TypeScript 環境の構築
- [x] Tailwind CSS の設定
- [x] Supabase クライアントの設定
- [x] 基本的なフォルダ構造の作成

### REVIEW-2: 認証システムの実装
- [x] AuthContext の作成
- [x] ログイン・新規登録フォームの実装
- [x] Supabase Auth との連携
- [x] 認証状態の管理

### REVIEW-3: レビュー投稿機能の実装
- [x] PostPage コンポーネントの作成
- [x] フォームバリデーション
- [x] 画像アップロード機能
- [x] Supabase Storage との連携
- [x] レビューデータの保存

### REVIEW-4: レビュー一覧・詳細表示機能
- [x] ReviewCard コンポーネントの作成
- [x] HomePage での最新レビュー表示
- [x] ReviewListPage での検索・フィルター機能
- [x] ReviewDetailPage での詳細表示
- [x] ページネーション機能

### REVIEW-5: いいね機能の実装
- [x] いいねボタンの実装
- [x] いいね数の表示
- [x] リアルタイムでのいいね数更新
- [x] ユーザーごとのいいね状態管理

### REVIEW-6: コメント機能の実装
- [x] CommentSection コンポーネントの作成
- [x] コメントの投稿・編集・削除機能
- [x] リアルタイムでのコメント数更新
- [x] コメント投稿時の通知機能（トリガー）

### REVIEW-7: プロフィールページの実装
- [x] ProfilePage コンポーネントの作成
- [x] ユーザー統計情報の表示
- [x] プロフィール編集機能
- [x] ユーザーが投稿したレビュー一覧
- [x] アカウント設定機能

### REVIEW-8: データベース最適化とマイグレーション修正
- [x] ユーザープロフィール制約の追加
- [x] インデックスの最適化
- [x] RLS ポリシーの改善
- [x] ユーザー統計ビューの作成
- [x] SQL 構文エラーの修正

### UI/UX 刷新タスク (Spotify 風デザイン)
- [x] **Tailwind CSS 設定更新:** `tailwind.config.js`にカラーパレット（ダークテーマ用の黒、グレー、アクセントカラー）、フォント、スペーシングなどのデザイントークンを定義
- [x] **グローバル CSS 修正:** `index.css`で、デフォルトの背景色や文字色をダークテーマに設定
- [x] **レイアウトコンポーネント作成:** アプリ全体のレイアウトの基盤となる`Layout.tsx`を作成・更新し、サイドバーやヘッダーの領域を確保
- [x] **ナビゲーションの再設計:** サイドバーまたはヘッダーを Spotify 風のシンプルで直感的なナビゲーションに更新
- [x] **ReviewCard の再設計:** レビュー一覧で表示される`ReviewCard.tsx`を、画像が際立つモダンなデザインに変更。ホバーエフェクトを追加
- [x] **ボタン・フォームの再設計:** アプリ全体で使用するボタンや入力フォームのデザインを、定義したカラーパレットに合わせて統一
- [x] **ホームページのレイアウト更新:** グリッドレイアウトを採用し、複数のレビューカードを整然と表示
- [x] **レビュー詳細ページのレイアウト更新:** `ReviewDetailPage`のコンポーネント配置を見直し、情報階層を明確化
- [x] **プロフィールページのレイアウト更新:** `ProfilePage`のデザインを刷新し、統計情報や投稿一覧を見やすく改善
- [x] **投稿ページのダークモード対応:** `PostPage`をSpotify風ダークテーマに対応

### 国際化(i18n)対応タスク
- [x] **`react-i18next`のインストール:** React Router DOMに適した軽量な国際化ライブラリを導入
- [x] **i18n設定ファイルの作成:** `src/i18n/index.ts`でi18nextの設定を行い、言語検出とローカルストレージ保存を実装
- [x] **翻訳ファイルの作成:** 日本語(`ja.json`)と英語(`en.json`)の翻訳リソースを作成し、全機能をカバー
- [x] **プロバイダの設定:** `I18nProvider`を作成し、アプリケーション全体で翻訳機能を使えるように設定
- [x] **言語切り替えコンポーネント:** `LanguageSwitcher`コンポーネントを作成し、ドロップダウンとボタン形式の両方に対応
- [x] **主要コンポーネントの翻訳:** ヘッダー、フッター、ナビゲーションなどの共通コンポーネント内の静的テキストを多言語化
- [x] **各ページの翻訳:** ホームページ、ログインページ、レビュー投稿ページなどのタイトルやラベルを多言語化
- [x] **残りのページの翻訳:** レビュー詳細ページ、検索・フィルターページ、プロフィールページ、コメントシステムの完全多言語化
- [x] **エラーメッセージの多言語化:** 全てのエラーメッセージとフィードバックメッセージの翻訳対応
- [x] **日付・時刻表示の多言語化:** 相対時間表示（○分前、○時間前など）の多言語対応
- [x] **フォームバリデーションの多言語化:** 入力フィールドのバリデーションメッセージの翻訳
- [x] **動的な値を含む翻訳:** 統計情報や検索結果数など、動的な値を含むテキストの適切な翻訳

### 地図からの住所選択機能タスク
- [x] **Mapboxライブラリの導入:** `mapbox-gl`と`@mapbox/mapbox-gl-geocoder`をインストール
- [x] **環境変数の設定:** Mapbox APIキーを`.env`ファイルに追加
- [x] **地図モーダルコンポーネントの作成:** `MapModal.tsx`を作成し、基本的なモーダル構造を実装
- [x] **「地図で選択」ボタンの追加:** 投稿フォームに地図モーダルを開くボタンを追加
- [x] **Mapboxマップコンポーネントの作成:** `MapboxMap.tsx`を作成し、地図の初期化と表示を実装
- [x] **ピンコンポーネントの作成:** ドラッグ可能なピンを地図上に表示する機能を実装
- [x] **地図の初期設定:** 東京駅を中心とした初期表示位置の設定
- [x] **レスポンシブ対応:** モバイルデバイスでの地図表示最適化
- [x] **エラーハンドリング:** APIキー未設定時や地図読み込み失敗時の適切なエラー表示
- [x] **ユーザビリティ改善:** ピンのホバーエフェクト、ドラッグ時の視覚的フィードバック
- [x] **現在地取得機能:** ユーザーの現在地を取得して地図に表示する機能
- [x] **ジオコーディングユーティリティの作成:** `src/utils/geocoding.ts`を作成し、Mapbox Geocoding APIを呼び出すユーティリティ関数を実装
- [x] **住所検索バーの強化:** `AddressSearchBar.tsx`を改良し、高度な検索機能とキーボードナビゲーションを実装
- [x] **検索結果の処理:** 検索結果から座標を取得し、地図とピンを移動させる機能を実装
- [x] **検索候補の表示:** 入力に応じた住所候補をドロップダウンで表示、カテゴリ別アイコン対応
- [x] **デバウンス処理:** API呼び出しの最適化のため、検索入力にデバウンス処理を追加
- [x] **エラーハンドリング:** 検索失敗時の適切なエラー表示とフォールバック処理
- [x] **住所バリデーション:** 入力された住所の妥当性チェック機能
- [x] **検索結果の分類:** 駅、住所、スポットなどのカテゴリ別表示
- [x] **キーボードナビゲーション:** 矢印キーとEnterキーによる検索結果選択
- [x] **リバースジオコーディングAPIクライアントの強化:** 座標から住所を取得するユーティリティ関数を高精度化
- [x] **ピン移動時の住所取得:** ピンがドラッグされた際に自動的に住所を取得する機能を実装
- [x] **住所フォーマット処理:** 取得した住所データを日本語形式で適切にフォーマット
- [x] **確定ボタンの実装:** 選択した位置と住所を親フォームに送信する機能を実装
- [x] **エラーハンドリング:** API呼び出し失敗時の適切なエラー表示とフォールバック処理
- [x] **住所品質評価システム:** 取得した住所の信頼度と品質を評価し、ユーザーに表示
- [x] **デバウンス処理とキャッシュ:** 不要なAPI呼び出しを防ぐためのキャッシュ機能
- [x] **フォールバック機能:** 住所取得失敗時の段階的フォールバック処理
- [x] **住所正規化:** 取得した住所の統一形式への変換機能
- [x] **投稿フォームとの統合:** 地図で選択した住所と座標をレビュー投稿フォームに正しく反映
- [x] **バリデーション追加:** 地図で選択された住所の妥当性チェック
- [x] **ユーザビリティ改善:** 地図操作のガイダンスとヘルプテキストの追加
- [x] **パフォーマンス最適化:** 地図ライブラリの遅延読み込みとメモリ使用量の最適化
- [x] **多言語対応:** 地図関連のUIテキストの国際化対応
- [x] **品質インジケーター:** 住所の精度を視覚的に表示するバッジシステム
- [x] **エラー回復機能:** ネットワークエラーや API制限時の適切な処理

### レビュー編集機能タスク
- [x] **編集権限の確認:** レビューの投稿者のみが編集できるように権限チェックを実装
- [x] **編集モードの実装:** レビュー詳細ページに編集ボタンと編集モードの切り替え機能を追加
- [x] **フォーム状態管理:** 編集時のフォームデータ管理と元データへのリセット機能
- [x] **画像編集機能:** 既存画像の削除、新規画像の追加、画像の管理機能
- [x] **地図連携:** 編集モードでも地図からの住所選択機能を利用可能
- [x] **バリデーション:** 編集時のデータ検証とエラーハンドリング
- [x] **保存機能:** 編集内容をデータベースに保存し、画像の追加・削除を処理
- [x] **UI/UX改善:** 編集中の視覚的フィードバックと操作性の向上
- [x] **多言語対応:** 編集機能関連のテキストの国際化対応

## PHASE 1: モノレポ基盤の構築 (完了)

### MONO-1: モノレポ環境のセットアップ
- [x] **Turborepoの初期化:** モノレポの基本構造を作成
- [x] **アプリケーションの配置:**
    - [x] `apps/web` に既存のWebアプリケーションを移動・統合
    - [x] `apps/mobile` に React Native (Expo) アプリケーションを作成
- [x] **ESLint/TypeScript設定の共通化:** ルートに共通のLinterとTSConfigを配置し、各アプリ・パッケージで継承するように設定

### MONO-2: 共有ライブラリの作成 (完了)
- [x] **`packages/logic` の作成:**
    - [x] Supabaseクライアントや、API通信、型定義などの既存ロジックをこのパッケージに移動
    - [x] WebアプリとMobileアプリがこの共有ロジックを参照できるように依存関係を設定
- [x] **`packages/ui` の作成:**
    - [x] `Tamagui` をセットアップし、WebとMobileの両方で動作する設定を完了
    - [x] 基本的なUIコンポーネント（Button, Card, Input, Text）を作成し、両アプリから利用可能

## PHASE 2: モバイルアプリの機能実装 (完了)

### MOBILE-1: 認証・プロフィール機能 (完了)
- [x] **画面作成:** ログイン、新規登録、プロフィール表示・編集画面を作成する (`packages/ui` のコンポーネントを利用)
- [x] **ロジック接続:** `packages/logic` のSupabase認証関数を呼び出し、認証機能を実装する

### MOBILE-2: レビュー閲覧・投稿機能 (完了)
- [x] **画面作成:** レビュー一覧、詳細、投稿フォーム画面を作成する
- [x] **地図機能の実装:** 現在地取得機能とMapbox APIを連携させ、Web版と同様の地図からの住所選択機能を実装する
- [x] **ロジック接続:** レビューデータの取得、投稿処理を実装する

### MOBILE-3: いいね・コメント機能 (完了)
- [x] **UI実装:** いいねボタン、コメントセクションをレビュー詳細画面に実装する
- [x] **リアルタイム機能:** Supabase Realtimeを利用し、いいねやコメントがリアルタイムに反映されるようにする
- [x] **コメント編集・削除:** ユーザーが自分のコメントを編集・削除できる機能を実装
- [x] **プッシュ通知基盤:** プッシュ通知の基盤となるデータベーステーブルとEdge Functionsを作成
- [x] **プッシュ通知フック:** React Nativeでプッシュ通知を管理するカスタムフックを実装

## PHASE 3: プッシュ通知機能の実装 (完了)

### PUSH-1: クライアントサイドの実装 (完了)
- [x] **権限の取得:** モバイルアプリ起動時に、ユーザーにプッシュ通知の許可を求めるダイアログを表示する
- [x] **トークンの保存:** ユーザーが許可した場合、Expoから取得したプッシュトークンを、Supabaseの`user_devices`テーブルに保存する
- [x] **通知ハンドリング:** 受信した通知の処理とアプリ内ナビゲーションを実装
- [x] **設定画面の実装:** プロフィール画面にプッシュ通知のオン/オフ切り替え機能を追加
- [x] **テスト通知機能:** 開発・デバッグ用のテスト通知送信機能を実装

### PUSH-2: サーバーサイドの実装 (完了)
- [x] **Edge Functionの作成:** `likes`や`comments`テーブルに新しい行が追加されたことをトリガーに実行されるSupabase Edge Functionを作成する
- [x] **通知送信ロジック:** Function内で、投稿主の`user_id`を元に`user_devices`テーブルからプッシュトークンを取得し、Expo Push Serviceに通知内容を送信する処理を実装する
- [x] **通知内容の最適化:** いいねとコメントで異なる通知メッセージを送信し、適切なデータを含める
- [x] **エラーハンドリング:** 通知送信失敗時の適切なエラー処理とログ出力を実装
- [x] **パフォーマンス最適化:** 通知トリガーの効率化とデータベース負荷の軽減

### PUSH-3: データベース拡張 (完了)
- [x] **user_devicesテーブルの作成:** プッシュ通知トークンを管理するテーブルを作成
- [x] **RLSポリシーの設定:** ユーザーが自分のデバイス情報のみアクセスできるようにセキュリティを設定
- [x] **通知トリガーの設定:** いいねとコメント投稿時に自動的にプッシュ通知を送信するトリガーを設定
- [x] **インデックスの最適化:** 通知処理のパフォーマンス向上のためのインデックス追加
- [x] **データベース設定の最終調整:** HTTP拡張の有効化と設定値の最適化

## PHASE 4: 最終統合とテスト

### INTEGRATION-1: 機能統合
- [ ] **Web・Mobile間の機能同等性確認:** 両プラットフォームで同じ機能が利用できることを確認
- [ ] **共有ライブラリの最適化:** `packages/logic`と`packages/ui`の使用状況を確認し、不要な依存関係を削除
- [ ] **プッシュ通知の統合テスト:** 実際のデバイスでの通知送受信テスト

### INTEGRATION-2: パフォーマンス最適化
- [ ] **ビルド時間の最適化:** Turborepoのキャッシュ機能を活用し、ビルド時間を短縮
- [ ] **バンドルサイズの最適化:** 不要なライブラリの削除とコード分割の実装
- [ ] **リアルタイム機能の最適化:** Supabase Realtimeの効率的な使用とメモリリーク防止

### INTEGRATION-3: デプロイメント準備
- [ ] **Web版のデプロイ設定:** Netlifyでのデプロイ設定をモノレポ構造に対応
- [ ] **Mobile版のビルド設定:** Expo EASでのビルド・配信設定
- [ ] **CI/CDパイプラインの構築:** GitHub Actionsでの自動ビルド・テスト・デプロイ設定
- [ ] **環境変数の管理:** 本番環境での適切な環境変数設定

## 技術スタック

### フロントエンド
- **Web**: React 18, TypeScript, Tailwind CSS, Vite
- **Mobile**: React Native, Expo, TypeScript
- **共通UI**: Tamagui (Web・Mobile両対応)

### バックエンド・サービス
- **BaaS**: Supabase (PostgreSQL, Auth, Storage, Functions, Realtime)
- **地図**: Mapbox GL JS, Mapbox Geocoding API
- **プッシュ通知**: Expo Push Notification Service
- **国際化**: React i18next

### 開発ツール
- **モノレポ管理**: Turborepo
- **ルーティング**: React Router DOM (Web), Expo Router (Mobile)
- **アイコン**: Lucide React (Web), Expo Vector Icons (Mobile)
- **ビルドツール**: Vite (Web), Metro (Mobile)

## データベース構造

- **users**: ユーザープロフィール情報
- **reviews**: レビュー投稿データ（latitude, longitude フィールド含む）
- **review_images**: レビュー画像
- **comments**: コメントデータ
- **likes**: いいね情報
- **user_devices**: プッシュ通知用デバイス情報
- **chat_histories**: チャット履歴（将来の拡張用）

## 主要機能

### 共通機能（Web・Mobile両対応）
1. ユーザー認証（登録・ログイン）
2. レビュー投稿（画像アップロード・地図選択対応）
3. レビュー編集（投稿者のみ）
4. レビュー検索・フィルタリング
5. いいね機能
6. コメント機能
7. プロフィール管理
8. レスポンシブデザイン
9. 多言語対応（日本語・英語）
10. 地図からの住所選択機能

### Mobile専用機能
11. プッシュ通知（いいね・コメント通知）
12. ネイティブ地図表示
13. リアルタイム機能（いいね・コメントの即座反映）
14. オフライン対応（将来の拡張）

## プロジェクト構造

```
yadori-monorepo/
├── apps/
│   ├── web/                 # Webアプリケーション (Vite + React)
│   └── mobile/              # モバイルアプリ (React Native + Expo)
├── packages/
│   ├── ui/                  # 共有UIライブラリ (Tamagui)
│   └── logic/               # 共有ビジネスロジック
├── supabase/
│   ├── migrations/          # データベースマイグレーション
│   └── functions/           # Edge Functions (プッシュ通知)
├── package.json             # ルートパッケージ設定
└── turbo.json              # Turborepo設定
```

## 今後の拡張予定

- リアルタイム通知機能の強化
- レビューの地図表示機能
- レビューの詳細検索（位置ベース）
- ユーザーフォロー機能
- レビューの共有機能
- オフライン対応
- PWA対応